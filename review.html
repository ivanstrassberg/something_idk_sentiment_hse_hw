<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Automatic Firefighter CRM</title>
    <style>
        body {
            margin: 0;
            font-family: Segoe UI;
            background: linear-gradient(135deg, #4f46e5, #9333ea);
            display: flex;
            justify-content: center;
            padding: 50px 20px;
        }

        .app {
            background: white;
            width: 700px;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.25);
        }

        textarea {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #ddd;
            resize: none;
        }

        button {
            margin-top: 15px;
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: #4f46e5;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        .card {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            color: white;
        }
    </style>
</head>

<body>
    <div class="app">
        <h2>üß† Automatic Firefighter</h2>

        <textarea id="reviewInput" rows="4" placeholder="Paste customer review..."></textarea>
        <button id="analyzeBtn">Analyze</button>

        <div id="sentimentResult"></div>
        <div id="action-result"></div>
        <p id="status"></p>
    </div>

    <script>

        const HF_MODEL = "https://router.huggingface.co/hf-inference/models/nlptown/bert-base-multilingual-uncased-sentiment";
        const LS_GAS = "gas_url";

        if (!localStorage.getItem("user_id")) {
            localStorage.setItem("user_id", "user_" + crypto.randomUUID());
        }

        function getUserId() {
            return localStorage.getItem("user_id");
        }

        function determineBusinessAction(stars) {
            if (stars <= 2) return "OFFER_COUPON";
            if (stars === 3) return "REQUEST_FEEDBACK";
            return "ASK_REFERRAL";
        }

        async function analyzeSentiment(review) {

            const token = localStorage.getItem("hf_token");

            const response = await fetch(HF_MODEL, {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    inputs: review,
                    options: { wait_for_model: true }
                })
            });

            const data = await response.json();
            const best = data[0].sort((a, b) => b.score - a.score)[0];

            return {
                stars: parseInt(best.label),
                confidence: best.score
            };
        }

        async function logEvent(payload) {

            const gasUrl = localStorage.getItem(LS_GAS);
            if (!gasUrl) return;

            payload.user_id = getUserId();
            payload.event_id = "event_" + crypto.randomUUID();

            const form = new URLSearchParams();
            Object.keys(payload).forEach(k => form.set(k, payload[k]));

            await fetch(gasUrl, {
                method: "POST",
                body: form
            });
        }

        document.getElementById("analyzeBtn").addEventListener("click", async () => {

            const review = document.getElementById("reviewInput").value.trim();
            if (!review) return;

            document.getElementById("status").textContent = "Analyzing...";

            const result = await analyzeSentiment(review);
            const action = determineBusinessAction(result.stars);

            localStorage.setItem("current_review", review);
            localStorage.setItem("current_stars", result.stars);
            localStorage.setItem("current_confidence", result.confidence);
            localStorage.setItem("current_action", action);

            document.getElementById("sentimentResult").innerHTML =
                `<strong>${result.stars} ‚≠ê</strong> (confidence ${result.confidence.toFixed(2)})`;

            document.getElementById("action-result").innerHTML =
                `<div class="card" style="background:${action === "OFFER_COUPON" ? "#ef4444" : action === "REQUEST_FEEDBACK" ? "#6b7280" : "#10b981"}">
Action: ${action}
<button onclick="handleAction()">Proceed</button>
</div>`;

            await logEvent({
                event_type: "AUTO_DECISION",
                review: review,
                stars: result.stars,
                confidence: result.confidence,
                action: action
            });

            document.getElementById("status").textContent = "Logged.";
        });

        async function handleAction() {

            const review = localStorage.getItem("current_review");
            const stars = localStorage.getItem("current_stars");
            const confidence = localStorage.getItem("current_confidence");
            const action = localStorage.getItem("current_action");

            if (action === "OFFER_COUPON") {

                await logEvent({
                    event_type: "COUPON_CLAIMED",
                    review,
                    stars,
                    confidence,
                    action,
                    coupon_claimed: "YES"
                });

                alert("Coupon claimed.");
            }

            if (action === "ASK_REFERRAL") {

                await logEvent({
                    event_type: "REFERRAL_CLICKED",
                    review,
                    stars,
                    confidence,
                    action,
                    referral_clicked: "YES"
                });

                window.open("https://example.com/referral", "_blank");
            }

            if (action === "REQUEST_FEEDBACK") {

                await logEvent({
                    event_type: "SURVEY_OPENED",
                    review,
                    stars,
                    confidence,
                    action,
                    survey_opened: "YES"
                });

                window.open("survey.html", "_blank");
            }
        }

    </script>
</body>

</html>